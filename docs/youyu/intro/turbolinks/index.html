<!DOCTYPE html><html lang="zh-CN" dir="ltr" data-layout="sandwich"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Turbolinks - 有渔前端团队</title><link rel="shortcut icon" href="/assets/favicon-622dec389ae4e3d07eca53ad857a69f4.png"><link rel="icon" href="/assets/favicon-5a093adcde5c588c8e4ea9dcd77bdf4c.ico"><link rel="stylesheet" href="/assets/global-f6051d0acaeb7b340ffb8269928978be.css"><link rel="stylesheet" href="/assets/pages/docs-05e3e5f36f590b4c2c0a3cf79248d9eb.css"> <script src="/assets/global-d0b5c2b672b2caf5f212d8158888d53c.js"></script><!--[if lt IE 9]><script src="/assets/support_ie8-88800734a0bafc4f91fe1d1fe0ce2289.js"></script><![endif]--></head><body itemscope itemtype="http://schema.org/WebPage" class="layout--sandwich" data-page="none"> <header class="layout-header"><div class="navbar navbar-static-top"><div class="container"><div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".Header-navs"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><h1 class="Header-brand navbar-brand"> <a href="/" title="有渔前端团队"> <span class="sr-only">有渔前端团队</span> <img src="/assets/logo-9fd24fb216fe5f9895da9e80e08e37a6.png" srcset="/assets/logo@2x-811b7b581c8fe20b05b670aae3268199.png 2x" class="Header-logo"> </a></h1></div> <nav class="Header-navs navbar-collapse collapse"><ul class="Menu nav navbar-nav navbar-right"><li><a href=" /" title="首页">首页</a></li><li class="is-selected"><a href="/docs/" title="文档">文档</a></li><li><a href="/demos/" title="演示">演示</a></li><li><a href="/about/" title="关于">关于</a></li></ul> </nav></div></div> </header> <main class="layout-container"><div class="layout-content"> <nav class="layout-breadcrumb"><div class="container"><ol class="breadcrumb"><li><a href="/">首页</a></li><li><a href="/docs/">文档</a></li><li><a href="/docs/youyu/">有渔工具库</a></li><li class="active">Turbolinks</li></ol></div> </nav><header class="Doc-header"><div class="container"><h1>有渔工具库</h1><p>介绍 YouYu 对象的用法及机制</p></div> </header><div class="Doc-container container"><div class="row"> <section class="Doc-content col-md-9"><header><h1>Turbolinks</h1><p class="lead">自从升级到 Rails 4 并引入 <a href="https://github.com/rails/turbolinks" target="_blank">Turbolinks</a> 之后，JavaScript 代码的执行逻辑发生了重大改变。现结合 Turbolinks 的机制特点将一些注意事项和容易犯的错误指出来，尽量避免发生。</p></header><h2>目录</h2><ul class="Doc-content--toc"><li> <a href="#changes-of-execution">代码执行逻辑的变化</a><ul><li><a href="#traditional-page-loading">传统的页面加载</a></li><li><a href="#turbolinks-dynamic-updating">Turbolinks 动态更新</a></li></ul></li></ul><h2 id="changes-of-execution">代码执行逻辑的变化</h2><p>Turbolinks 的引入给原来的代码执行的流程控制带来了毁灭性的冲击……然而，我们要去拥抱变化！</p><h3 id="traditional-page-loading">传统的页面加载</h3><p>引入 Turbolinks 之前，页面的加载是传统的方式——进入新页面，浏览器对 HTML 文档及资源进行加载并解析，会触发 <code>DOMContentLoaded</code> 和 <code>load</code> 等事件。通过 <code>YouYu.prepare()</code>、<code>YouYu.ready()</code>、<code>YouYu.sandbox()</code> 三个方法就能控制代码的执行顺序。</p><div class="Example-code"><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// 向 YouYu 内部队列中添加函数</span>
<span class="c1">// 在调用 YouYu.sandbox() 后立即执行</span>
<span class="nx">YouYu</span><span class="p">.</span><span class="nx">prepare</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// To do sth.</span>
<span class="p">});</span>

<span class="c1">// 向 YouYu 内部队列中添加函数</span>
<span class="c1">// 在触发 DOMContentLoaded 后执行</span>
<span class="nx">YouYu</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// To do sth.</span>
<span class="p">});</span>

<span class="c1">// 启动封闭的代码执行环境</span>
<span class="c1">// 只有调用该方法后通过 YouYu.prepare() 和 YouYu.ready() 添加的函数才会执行</span>
<span class="nx">YouYu</span><span class="p">.</span><span class="nx">sandbox</span><span class="p">();</span></code></pre></div></div><h3 id="turbolinks-dynamic-updating">Turbolinks 动态更新</h3><p>Turbolinks 的主要特点就是不更改 <code>&lt;head&gt;</code> 的内容，通过 AJAX 来替换 HTML 文档的 <code>&lt;body&gt;</code>，使页面内容的更新看起来更优雅一些。因此，正常情况下真正的页面加载只有一次，会带来以下问题：</p><ul><li>原来的代码执行流程控制已失效；</li><li>无法准确地判断当前页面（<code>&lt;body&gt;</code> 的 <code>data-page</code> 属性）；</li><li>依赖于 <code>&lt;body&gt;</code> 中由 <code>&lt;script&gt;</code> 引入的脚本的代码执行出错；</li><li><code>window</code> 和 <code>document</code> 对象是全局唯一的，针对指定页面的操作要避免涉及到这两个对象，例如事件处理，最好是绑定到 <code>&lt;body&gt;</code> 上——<code>$("body").on("click", function() {});</code>。</li></ul><p>为了使原来的代码适应如此巨大的变化而重写了原来的 <code>YouYu.prepare()</code>、<code>YouYu.ready()</code>、<code>YouYu.sandbox()</code>；添加了 <code>YouYu.inPage()</code> 方法进行指定页面判断；默认引入了 <a href="https://github.com/kossnocorp/jquery.turbolinks" target="_blank">jQuery Turbolinks</a> 解决 jQuery 的 <code>$(document).ready()</code>。</p><p>新的流程控制逻辑是在触发 <code>DOMContentLoaded</code> 事件或者 <code>page:load</code> 事件时分别先后执行由 <code>YouYu.prepare()</code> 和 <code>YouYu.ready()</code> 添加的函数。简而言之，代码在页面内容加载完成后执行。</p></section><div class="Doc-toc col-md-3"> <nav><ul class="Doc-navs"><li class="is-selected"> <a href="/docs/youyu/">用前须知</a><ul class="Doc-subnavs"><li><a href="/docs/youyu/">介绍</a></li><li class="is-selected"><a href="/docs/youyu/intro/turbolinks/">Turbolinks</a></li></ul></li><li><a href="/docs/youyu/apis/core/">API</a></li></ul> </nav></div></div></div></div> </main> <script src="/assets/pages/docs-f88a7a1d43da6d1b6a95f37b50fcb764.js"></script></body></html>